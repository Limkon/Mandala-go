name: Generate Gradle Wrapper

on:
  workflow_dispatch:  # 手动触发

jobs:
  generate-wrapper:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码（完整历史，以便 push）
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 完整历史，便于 push

      # 2. 设置 Java（Gradle 需要）
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. 设置 Gradle（安装指定版本）
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.5'  # 与你的项目兼容；可改为 '9.2.1' 等最新版

      # 4. 生成 Gradle Wrapper
      - name: Generate Gradle Wrapper
        working-directory: ./android  # 进入你的 Android 项目目录
        run: |
          gradle wrapper --gradle-version 8.5 --distribution-type all
          echo "Gradle Wrapper 生成完成！"
          ls -la  # 显示生成的 gradlew 等文件
          ls -la gradle/wrapper/

      # 5. Commit 并 Push 生成的文件（需要 GITHUB_TOKEN 权限）
      - name: Commit and Push Wrapper Files
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add android/gradlew android/gradlew.bat android/gradle/wrapper/
          git commit -m "chore: add Gradle Wrapper files (generated by CI)" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}

      # 6. 输出总结
      - name: Summary
        run: |
          echo "Gradle Wrapper 已成功生成并推送到仓库！"
          echo "现在你的主构建 workflow 可以正常使用 ./gradlew 了。"
